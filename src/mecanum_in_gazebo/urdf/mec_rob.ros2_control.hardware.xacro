<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- Arguments passed from main URDF -->
  <xacro:arg name="use_sim" default="true"/>
  <xacro:arg name="esp1_port" default="/dev/ttyUSB0"/>
  <xacro:arg name="esp2_port" default="/dev/ttyUSB1"/>

  <!-- Simulation Hardware Interface (Gazebo) -->
  <xacro:if value="$(arg use_sim)">
    <ros2_control name="GazeboSystem" type="system">
      <hardware>
        <plugin>gazebo_ros2_control/GazeboSystem</plugin>
      </hardware>
      
      <joint name="front_left_joint">
        <command_interface name="velocity">
          <param name="min">-50</param>
          <param name="max">50</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      
      <joint name="front_right_joint">
        <command_interface name="velocity">
          <param name="min">-50</param>
          <param name="max">50</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      
      <joint name="back_left_joint">
        <command_interface name="velocity">
          <param name="min">-50</param>
          <param name="max">50</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      
      <joint name="back_right_joint">
        <command_interface name="velocity">
          <param name="min">-50</param>
          <param name="max">50</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
    </ros2_control>
  </xacro:if>

  <!-- Real Hardware Interface (RPi + ESP + Steppers) -->
  <xacro:unless value="$(arg use_sim)">
    <ros2_control name="MecanumStepperSystem" type="system">
      <hardware>
        <plugin>mecanum_hardware/MecanumStepperInterface</plugin>
        <param name="esp1_port">$(arg esp1_port)</param>
        <param name="esp2_port">$(arg esp2_port)</param>
        <param name="esp_baudrate">115200</param>
        
        <!-- NEMA23 Stepper parameters -->
        <param name="steps_per_revolution">200</param>  <!-- 1.8Â° per step = 200 steps/rev -->
        <param name="wheel_radius">0.05</param>          <!-- 5cm wheel radius -->
        <param name="gear_ratio">1.0</param>             <!-- Direct drive, change if geared -->
        
        <!-- Robot dimensions for mecanum kinematics -->
        <param name="wheel_separation_x">0.25</param>    <!-- Front-back distance (m) -->
        <param name="wheel_separation_y">0.30</param>    <!-- Left-right distance (m) -->
        
        <!-- IMU fusion -->
        <param name="use_imu">true</param>               <!-- Use IMU for sensor fusion -->
      </hardware>
      
      <joint name="front_left_joint">
        <command_interface name="velocity">
          <param name="min">-30</param>
          <param name="max">30</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      
      <joint name="front_right_joint">
        <command_interface name="velocity">
          <param name="min">-30</param>
          <param name="max">30</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      
      <joint name="back_left_joint">
        <command_interface name="velocity">
          <param name="min">-30</param>
          <param name="max">30</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      
      <joint name="back_right_joint">
        <command_interface name="velocity">
          <param name="min">-30</param>
          <param name="max">30</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
    </ros2_control>
  </xacro:unless>

</robot>